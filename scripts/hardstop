#!/bin/bash
set -euo pipefail

SCRIPT="$HOME/.local/bin/hardstop-kickout.sh"
PLIST="$HOME/Library/LaunchAgents/com.hardstop.kickout.plist"
STATE_DIR="$HOME/.local/share/hardstop"
REPO_FILE="$STATE_DIR/repo_path"
GUI_DOMAIN="gui/$(/usr/bin/id -u)"

usage() {
  cat <<'USAGE'
Usage: hardstop <command>

Hard Stop - Enforces computer shutdown during quiet hours (9 PM - 8 AM)

Commands:
  install       Re-install from the recorded repo path
  config        Edit config (YAML)
  enable        Load and enable the LaunchAgent
  disable       Unload and disable the LaunchAgent
  reload        Reload the LaunchAgent
  status        Show current status (in quiet hours or not)
  test          Check if would shutdown (doesn't actually shutdown)
  help          Show this help
USAGE
}

install_from_repo() {
  local repo_root script_dir
  repo_root="${HARDSTOP_REPO:-}"

  if [ -z "$repo_root" ] && [ -f "$REPO_FILE" ]; then
    repo_root="$(/bin/cat "$REPO_FILE")"
  fi

  if [ -z "$repo_root" ]; then
    script_dir="$(cd "$(dirname "$0")" && pwd)"
    if [ -f "$script_dir/install.sh" ]; then
      repo_root="$(cd "$script_dir/.." && pwd)"
    fi
  fi

  if [ -z "$repo_root" ] || [ ! -f "$repo_root/scripts/install.sh" ]; then
    echo "Repo not found. Run: (cd <repo> && bash scripts/install.sh)" >&2
    exit 1
  fi

  /bin/bash "$repo_root/scripts/install.sh"
}

get_config_file() {
  local repo_root config_file
  config_file="$HOME/Library/Application Support/hardstop/config.yml"

  if [ -f "$REPO_FILE" ]; then
    repo_root="$(/bin/cat "$REPO_FILE" 2>/dev/null || echo "")"
    if [ -n "$repo_root" ] && [ -f "$repo_root/config.yml" ]; then
      config_file="$repo_root/config.yml"
    fi
  fi

  echo "$config_file"
}

require_script() {
  if [ ! -f "$SCRIPT" ]; then
    echo "Missing $SCRIPT. Run ./scripts/install.sh first." >&2
    exit 1
  fi
}

require_plist() {
  if [ ! -f "$PLIST" ]; then
    echo "Missing $PLIST. Run ./scripts/install.sh first." >&2
    exit 1
  fi
}

is_loaded() {
  /bin/launchctl list 2>/dev/null | /usr/bin/grep -q "com.hardstop.kickout"
}

cmd="${1:-help}"

case "$cmd" in
  install)
    install_from_repo
    ;;
  config)
    config_file="$(get_config_file)"
    /bin/mkdir -p "$(/usr/bin/dirname "$config_file")"
    if [ -n "${EDITOR:-}" ]; then
      "${EDITOR}" "$config_file"
    elif /usr/bin/command -v vim >/dev/null 2>&1; then
      /usr/bin/vim "$config_file"
    else
      /usr/bin/nano "$config_file"
    fi
    ;;
  enable)
    require_plist
    /bin/launchctl enable "$GUI_DOMAIN/com.hardstop.kickout" >/dev/null 2>&1 || true
    if is_loaded; then
      echo "Already enabled"
    else
      /bin/launchctl bootstrap "$GUI_DOMAIN" "$PLIST"
      echo "Enabled - shutdown will be enforced during quiet hours"
    fi
    ;;
  disable)
    require_plist
    /bin/launchctl disable "$GUI_DOMAIN/com.hardstop.kickout" >/dev/null 2>&1 || true
    /bin/launchctl bootout "$GUI_DOMAIN" "$PLIST" >/dev/null 2>&1 || true
    echo "Disabled - shutdown enforcement paused"
    ;;
  reload)
    require_plist
    /bin/launchctl bootout "$GUI_DOMAIN" "$PLIST" >/dev/null 2>&1 || true
    /bin/launchctl enable "$GUI_DOMAIN/com.hardstop.kickout" >/dev/null 2>&1 || true
    /bin/launchctl bootstrap "$GUI_DOMAIN" "$PLIST"
    echo "Reloaded"
    ;;
  status)
    require_script
    if is_loaded; then
      echo "LaunchAgent: enabled"
    else
      echo "LaunchAgent: disabled"
    fi
    "$SCRIPT" --status
    ;;
  test)
    require_script
    "$SCRIPT" --test
    ;;
  help|-h|--help)
    usage
    ;;
  *)
    echo "Unknown command: $cmd" >&2
    usage
    exit 1
    ;;
esac
