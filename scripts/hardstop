#!/bin/bash
set -euo pipefail

SCRIPT="$HOME/.local/bin/hardstop-kickout.sh"
PLIST="$HOME/Library/LaunchAgents/com.hardstop.kickout.plist"
STATE_DIR="$HOME/.local/share/hardstop"
REPO_FILE="$STATE_DIR/repo_path"
GUI_DOMAIN="gui/$(/usr/bin/id -u)"
HARDSTOP_STATE_DIR="$HOME/Library/Application Support/hardstop"
TEST_LIVE_FILE="$HARDSTOP_STATE_DIR/test_live_until"
TEST_LIVE_INTERVAL_FILE="$HARDSTOP_STATE_DIR/test_live_interval"

# Default test-live settings
TEST_LIVE_DURATION=180    # 3 minutes total test duration
TEST_LIVE_INTERVAL=60     # 60 second check interval during test

usage() {
  cat <<'USAGE'
Usage: hardstop <command>

Hard Stop - Enforces computer shutdown during quiet hours (9 PM - 8 AM)

Commands:
  install       Re-install from the recorded repo path
  config        Edit config (YAML)
  enable        Load and enable the LaunchAgent
  disable       Unload and disable the LaunchAgent
  reload        Reload the LaunchAgent
  status        Show current status (in quiet hours or not)
  check         Check if would shutdown (doesn't actually shutdown)
  test          Run the test suite (no actual shutdowns)
  test-live [duration] [interval]
                ACTUALLY shutdown to test the system works!
                - duration: how long test mode lasts (default: 180s = 3 min)
                - interval: how often to shutdown (default: 60s = 1 min)
                Computer will shutdown immediately, then every <interval> seconds
                until <duration> expires. Then returns to normal.
  test-live-cancel
                Cancel an active test-live session
  help          Show this help

Examples:
  hardstop test-live              # 3 min test, shutdown every 60s
  hardstop test-live 300 30       # 5 min test, shutdown every 30s
  hardstop test-live-cancel       # Abort test mode immediately
USAGE
}

install_from_repo() {
  local repo_root script_dir
  repo_root="${HARDSTOP_REPO:-}"

  if [ -z "$repo_root" ] && [ -f "$REPO_FILE" ]; then
    repo_root="$(/bin/cat "$REPO_FILE")"
  fi

  if [ -z "$repo_root" ]; then
    script_dir="$(cd "$(dirname "$0")" && pwd)"
    if [ -f "$script_dir/install.sh" ]; then
      repo_root="$(cd "$script_dir/.." && pwd)"
    fi
  fi

  if [ -z "$repo_root" ] || [ ! -f "$repo_root/scripts/install.sh" ]; then
    echo "Repo not found. Run: (cd <repo> && bash scripts/install.sh)" >&2
    exit 1
  fi

  /bin/bash "$repo_root/scripts/install.sh"
}

get_config_file() {
  local repo_root config_file
  config_file="$HOME/Library/Application Support/hardstop/config.yml"

  if [ -f "$REPO_FILE" ]; then
    repo_root="$(/bin/cat "$REPO_FILE" 2>/dev/null || echo "")"
    if [ -n "$repo_root" ] && [ -f "$repo_root/config.yml" ]; then
      config_file="$repo_root/config.yml"
    fi
  fi

  echo "$config_file"
}

require_script() {
  if [ ! -f "$SCRIPT" ]; then
    echo "Missing $SCRIPT. Run ./scripts/install.sh first." >&2
    exit 1
  fi
}

require_plist() {
  if [ ! -f "$PLIST" ]; then
    echo "Missing $PLIST. Run ./scripts/install.sh first." >&2
    exit 1
  fi
}

is_loaded() {
  /bin/launchctl list 2>/dev/null | /usr/bin/grep -q "com.hardstop.kickout"
}

start_test_live() {
  local duration="${1:-$TEST_LIVE_DURATION}"
  local interval="${2:-$TEST_LIVE_INTERVAL}"

  # Validate inputs
  if ! printf "%s" "$duration" | grep -Eq '^[0-9]+$'; then
    echo "Duration must be a number (seconds)" >&2
    exit 1
  fi
  if ! printf "%s" "$interval" | grep -Eq '^[0-9]+$'; then
    echo "Interval must be a number (seconds)" >&2
    exit 1
  fi
  if [ "$interval" -lt 10 ]; then
    echo "Interval must be at least 10 seconds" >&2
    exit 1
  fi

  require_plist
  require_script

  # Calculate expiration time
  local expire_time=$(( $(/bin/date +%s) + duration ))

  echo "========================================"
  echo "  STARTING LIVE SHUTDOWN TEST"
  echo "========================================"
  echo ""
  echo "WARNING: Your computer WILL shutdown in 5 seconds!"
  echo ""
  echo "Test settings:"
  echo "  - Duration: ${duration} seconds ($((duration / 60)) min)"
  echo "  - Interval: ${interval} seconds"
  echo "  - Shutdowns: ~$((duration / interval)) times"
  echo ""
  echo "After ${duration}s, test mode will auto-expire."
  echo "To cancel early: hardstop test-live-cancel"
  echo ""
  echo "Press Ctrl+C within 5 seconds to abort..."
  sleep 5

  # Create state directory and write expiration time + interval
  /bin/mkdir -p "$HARDSTOP_STATE_DIR"
  echo "$expire_time" > "$TEST_LIVE_FILE"
  echo "$interval" > "$TEST_LIVE_INTERVAL_FILE"

  # Temporarily set a faster interval for the LaunchAgent
  /usr/bin/plutil -replace StartInterval -integer "$interval" "$PLIST"

  # Reload LaunchAgent with new interval
  /bin/launchctl bootout "$GUI_DOMAIN" "$PLIST" >/dev/null 2>&1 || true
  /bin/launchctl enable "$GUI_DOMAIN/com.hardstop.kickout" >/dev/null 2>&1 || true
  /bin/launchctl bootstrap "$GUI_DOMAIN" "$PLIST"

  echo ""
  echo "Test mode ACTIVE. Shutting down NOW..."
  echo "(Test expires at: $(/bin/date -r "$expire_time" "+%H:%M:%S" 2>/dev/null || /bin/date -d "@$expire_time" "+%H:%M:%S" 2>/dev/null || echo "epoch $expire_time"))"

  # Trigger immediate shutdown
  /usr/bin/sudo /sbin/shutdown -h now
}

cancel_test_live() {
  require_plist

  if [ -f "$TEST_LIVE_FILE" ]; then
    /bin/rm -f "$TEST_LIVE_FILE"
    /bin/rm -f "$TEST_LIVE_INTERVAL_FILE"
    echo "Test-live mode cancelled."
  else
    echo "No active test-live session."
  fi

  # Restore normal interval (300 seconds)
  local config_file normal_interval
  config_file="$(get_config_file)"
  normal_interval=$(/usr/bin/awk '/^lock_interval_seconds:/ {sub(/.*:/, ""); gsub(/[" ]/, ""); sub(/#.*/, ""); print}' "$config_file" 2>/dev/null || echo "300")

  if ! printf "%s" "$normal_interval" | grep -Eq '^[0-9]+$'; then
    normal_interval=300
  fi

  /usr/bin/plutil -replace StartInterval -integer "$normal_interval" "$PLIST"

  # Reload with normal interval
  /bin/launchctl bootout "$GUI_DOMAIN" "$PLIST" >/dev/null 2>&1 || true
  /bin/launchctl enable "$GUI_DOMAIN/com.hardstop.kickout" >/dev/null 2>&1 || true
  /bin/launchctl bootstrap "$GUI_DOMAIN" "$PLIST"

  echo "Restored normal interval: ${normal_interval}s"
}

cmd="${1:-help}"

case "$cmd" in
  install)
    install_from_repo
    ;;
  config)
    config_file="$(get_config_file)"
    /bin/mkdir -p "$(/usr/bin/dirname "$config_file")"
    if [ -n "${EDITOR:-}" ]; then
      "${EDITOR}" "$config_file"
    elif /usr/bin/command -v vim >/dev/null 2>&1; then
      /usr/bin/vim "$config_file"
    else
      /usr/bin/nano "$config_file"
    fi
    ;;
  enable)
    require_plist
    /bin/launchctl enable "$GUI_DOMAIN/com.hardstop.kickout" >/dev/null 2>&1 || true
    if is_loaded; then
      echo "Already enabled"
    else
      /bin/launchctl bootstrap "$GUI_DOMAIN" "$PLIST"
      echo "Enabled - shutdown will be enforced during quiet hours"
    fi
    ;;
  disable)
    require_plist
    /bin/launchctl disable "$GUI_DOMAIN/com.hardstop.kickout" >/dev/null 2>&1 || true
    /bin/launchctl bootout "$GUI_DOMAIN" "$PLIST" >/dev/null 2>&1 || true
    echo "Disabled - shutdown enforcement paused"
    ;;
  reload)
    require_plist
    /bin/launchctl bootout "$GUI_DOMAIN" "$PLIST" >/dev/null 2>&1 || true
    /bin/launchctl enable "$GUI_DOMAIN/com.hardstop.kickout" >/dev/null 2>&1 || true
    /bin/launchctl bootstrap "$GUI_DOMAIN" "$PLIST"
    echo "Reloaded"
    ;;
  status)
    require_script
    if is_loaded; then
      echo "LaunchAgent: enabled"
    else
      echo "LaunchAgent: disabled"
    fi
    "$SCRIPT" --status
    ;;
  check)
    require_script
    "$SCRIPT" --test
    ;;
  test)
    # Find repo path to run test suite
    test_repo_root=""
    if [ -f "$REPO_FILE" ]; then
      test_repo_root="$(/bin/cat "$REPO_FILE")"
    fi
    if [ -z "$test_repo_root" ] || [ ! -f "$test_repo_root/scripts/test.sh" ]; then
      # Try relative to this script
      test_script_dir="$(cd "$(dirname "$0")" && pwd)"
      if [ -f "$test_script_dir/test.sh" ]; then
        test_repo_root="$(cd "$test_script_dir/.." && pwd)"
      fi
    fi
    if [ -z "$test_repo_root" ] || [ ! -f "$test_repo_root/scripts/test.sh" ]; then
      echo "Cannot find test.sh. Run from repo or after install." >&2
      exit 1
    fi
    /bin/bash "$test_repo_root/scripts/test.sh"
    ;;
  test-live)
    start_test_live "${2:-}" "${3:-}"
    ;;
  test-live-cancel)
    cancel_test_live
    ;;
  help|-h|--help)
    usage
    ;;
  *)
    echo "Unknown command: $cmd" >&2
    usage
    exit 1
    ;;
esac
